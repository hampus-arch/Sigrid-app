{% comment %}
  Sigrid AI Chat Widget
  Design matched to ChatKit Playground
{% endcomment %}

{% if block.settings.enabled %}
<div id="sigrid-chat-widget-container"></div>

<style>
  /* OpenAI Sans Font */
  @font-face {
    font-family: 'OpenAI Sans';
    src: url('https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-Regular.woff2') format('woff2');
    font-weight: 400;
    font-style: normal;
    font-display: swap;
  }
  @font-face {
    font-family: 'OpenAI Sans';
    src: url('https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-Medium.woff2') format('woff2');
    font-weight: 500;
    font-style: normal;
    font-display: swap;
  }
  @font-face {
    font-family: 'OpenAI Sans';
    src: url('https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-SemiBold.woff2') format('woff2');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
  }

  /* ChatKit Design Variables */
  :root {
    --ck-accent: #b8d1c2;
    --ck-accent-hover: #a5c4b3;
    --ck-surface: #f6f5ee;
    --ck-surface-elevated: #ffffff;
    --ck-text-primary: #1a1a1a;
    --ck-text-secondary: #6b6b6b;
    --ck-text-tertiary: #9a9a9a;
    --ck-border: rgba(0, 0, 0, 0.08);
    --ck-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    --ck-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
    --ck-radius: 24px;
    --ck-radius-full: 9999px;
    --ck-font: "OpenAI Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --ck-font-size: 15px;
  }

  #sigrid-chat-widget-container {
    position: fixed;
    bottom: {{ block.settings.position_bottom }}px;
    right: {{ block.settings.position_right }}px;
    z-index: 9999;
    font-family: var(--ck-font);
    font-size: var(--ck-font-size);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Toggle Button */
  .ck-toggle {
    width: 56px;
    height: 56px;
    border-radius: var(--ck-radius-full);
    background: var(--ck-accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--ck-shadow-lg);
    transition: all 0.2s ease;
  }

  .ck-toggle:hover {
    background: var(--ck-accent-hover);
    transform: scale(1.05);
  }

  .ck-toggle svg {
    width: 24px;
    height: 24px;
    fill: var(--ck-text-primary);
  }

  /* Chat Window */
  .ck-window {
    position: absolute;
    bottom: 68px;
    right: 0;
    width: 380px;
    height: 520px;
    background: var(--ck-surface);
    border-radius: var(--ck-radius);
    box-shadow: var(--ck-shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--ck-border);
  }

  .ck-window.open {
    display: flex;
    animation: ck-slide-up 0.25s ease-out;
  }

  @keyframes ck-slide-up {
    from {
      opacity: 0;
      transform: translateY(8px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Header - ChatKit Style */
  .ck-header {
    padding: 16px 20px;
    background: var(--ck-accent);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--ck-border);
  }

  .ck-header-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--ck-text-primary);
    margin: 0;
  }

  .ck-header-actions {
    display: flex;
    gap: 4px;
  }

  .ck-header-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--ck-radius-full);
    background: rgba(0, 0, 0, 0.06);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s ease;
    color: var(--ck-text-primary);
  }

  .ck-header-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .ck-header-btn svg {
    width: 16px;
    height: 16px;
  }

  /* Messages Area */
  .ck-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--ck-surface);
  }

  .ck-messages::-webkit-scrollbar {
    width: 6px;
  }

  .ck-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  .ck-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 3px;
  }

  /* Start Screen / Greeting */
  .ck-start-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 30px;
    text-align: center;
  }

  .ck-greeting {
    font-size: 20px;
    font-weight: 500;
    color: var(--ck-text-primary);
    margin: 0;
    letter-spacing: -0.01em;
  }

  /* Messages */
  .ck-message {
    max-width: 85%;
    padding: 12px 16px;
    font-size: var(--ck-font-size);
    line-height: 1.5;
    word-wrap: break-word;
    border-radius: 18px;
  }

  .ck-message.user {
    background: var(--ck-accent);
    color: var(--ck-text-primary);
    align-self: flex-end;
    border-bottom-right-radius: 6px;
  }

  .ck-message.assistant {
    background: var(--ck-surface-elevated);
    color: var(--ck-text-primary);
    align-self: flex-start;
    border-bottom-left-radius: 6px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
  }

  /* Typing Indicator */
  .ck-message.typing {
    display: flex;
    gap: 4px;
    padding: 16px 18px;
    background: var(--ck-surface-elevated);
  }

  .ck-message.typing span {
    width: 6px;
    height: 6px;
    background: var(--ck-text-tertiary);
    border-radius: var(--ck-radius-full);
    animation: ck-typing 1.2s ease-in-out infinite;
  }

  .ck-message.typing span:nth-child(2) { animation-delay: 0.15s; }
  .ck-message.typing span:nth-child(3) { animation-delay: 0.3s; }

  @keyframes ck-typing {
    0%, 60%, 100% { 
      transform: translateY(0); 
      opacity: 0.4;
    }
    30% { 
      transform: translateY(-4px); 
      opacity: 1;
    }
  }

  /* Composer / Input Area */
  .ck-composer {
    padding: 16px;
    background: var(--ck-surface-elevated);
    border-top: 1px solid var(--ck-border);
  }

  .ck-input-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--ck-surface);
    border-radius: var(--ck-radius-full);
    padding: 4px 4px 4px 20px;
    border: 1px solid var(--ck-border);
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .ck-input-wrapper:focus-within {
    border-color: var(--ck-accent-hover);
    box-shadow: 0 0 0 3px rgba(184, 209, 194, 0.25);
  }

  .ck-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--ck-font-size);
    font-family: var(--ck-font);
    color: var(--ck-text-primary);
    outline: none;
    padding: 10px 0;
  }

  .ck-input::placeholder {
    color: var(--ck-text-tertiary);
  }

  .ck-send {
    width: 40px;
    height: 40px;
    border-radius: var(--ck-radius-full);
    background: var(--ck-accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    flex-shrink: 0;
  }

  .ck-send:hover {
    background: var(--ck-accent-hover);
  }

  .ck-send:active {
    transform: scale(0.95);
  }

  .ck-send:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .ck-send svg {
    width: 18px;
    height: 18px;
    fill: var(--ck-text-primary);
  }

  /* Disclaimer */
  .ck-disclaimer {
    text-align: center;
    padding: 8px 16px 0;
    font-size: 12px;
    color: var(--ck-text-tertiary);
  }

  /* Mobile Responsive */
  @media (max-width: 480px) {
    .ck-window {
      width: calc(100vw - 24px);
      height: calc(100vh - 100px);
      bottom: 68px;
      right: -{{ block.settings.position_right | minus: 12 }}px;
      border-radius: 20px;
    }
  }
</style>

<script>
(function() {
  const API_URL = '{{ block.settings.api_url }}';
  const GREETING = '{{ block.settings.greeting | default: "How can I help you today?" }}';
  const HEADER_TITLE = '{{ block.settings.header_title | default: "How can I help you today?" }}';
  const PLACEHOLDER = '{{ block.settings.placeholder | default: "Skicka meddelande till AI" }}';
  
  const SESSION_ID = 'ck_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();

  const container = document.getElementById('sigrid-chat-widget-container');
  container.innerHTML = `
    <button class="ck-toggle" aria-label="Öppna chatt">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      </svg>
    </button>
    <div class="ck-window">
      <div class="ck-header">
        <h3 class="ck-header-title">${HEADER_TITLE}</h3>
        <div class="ck-header-actions">
          <button class="ck-header-btn ck-close" aria-label="Stäng">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="ck-messages">
        <div class="ck-start-screen">
          <h2 class="ck-greeting">${GREETING}</h2>
        </div>
      </div>
      <div class="ck-composer">
        <div class="ck-input-wrapper">
          <input type="text" class="ck-input" placeholder="${PLACEHOLDER}" />
          <button class="ck-send" aria-label="Skicka">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `;

  let isOpen = false;
  let hasMessages = false;

  const toggle = container.querySelector('.ck-toggle');
  const close = container.querySelector('.ck-close');
  const window = container.querySelector('.ck-window');
  const messages = container.querySelector('.ck-messages');
  const input = container.querySelector('.ck-input');
  const send = container.querySelector('.ck-send');

  function toggleChat() {
    isOpen = !isOpen;
    window.classList.toggle('open', isOpen);
    if (isOpen) input.focus();
  }

  toggle.addEventListener('click', toggleChat);
  close.addEventListener('click', toggleChat);

  function addMessage(content, role) {
    if (!hasMessages) {
      const startScreen = messages.querySelector('.ck-start-screen');
      if (startScreen) startScreen.remove();
      hasMessages = true;
    }

    const msg = document.createElement('div');
    msg.className = `ck-message ${role}`;
    msg.textContent = content;
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  function showTyping() {
    const typing = document.createElement('div');
    typing.className = 'ck-message assistant typing';
    typing.id = 'ck-typing';
    typing.innerHTML = '<span></span><span></span><span></span>';
    messages.appendChild(typing);
    messages.scrollTop = messages.scrollHeight;
  }

  function hideTyping() {
    const typing = document.getElementById('ck-typing');
    if (typing) typing.remove();
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    send.disabled = true;

    addMessage(text, 'user');
    showTyping();

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, sessionId: SESSION_ID })
      });

      hideTyping();

      if (res.ok) {
        const data = await res.json();
        addMessage(data.response || 'Inget svar mottaget.', 'assistant');
      } else {
        addMessage('Något gick fel. Försök igen.', 'assistant');
      }
    } catch (e) {
      hideTyping();
      console.error('Chat error:', e);
      addMessage('Kunde inte ansluta. Försök igen.', 'assistant');
    }

    send.disabled = false;
    input.focus();
  }

  send.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Sigrid Chat Widget",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Aktivera chat widget",
      "default": true
    },
    {
      "type": "url",
      "id": "api_url",
      "label": "API URL",
      "info": "https://sigrid-app.vercel.app/api/chat"
    },
    {
      "type": "text",
      "id": "header_title",
      "label": "Header text",
      "default": "How can I help you today?"
    },
    {
      "type": "text",
      "id": "greeting",
      "label": "Greeting",
      "default": "How can I help you today?"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input placeholder",
      "default": "Skicka meddelande till AI"
    },
    {
      "type": "range",
      "id": "position_bottom",
      "label": "Position bottom (px)",
      "min": 10,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "position_right",
      "label": "Position right (px)",
      "min": 10,
      "max": 100,
      "step": 5,
      "default": 20
    }
  ]
}
{% endschema %}
